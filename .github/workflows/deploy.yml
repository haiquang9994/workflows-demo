name: Deploy to Production

on:
  push:
    branches:
      - production

jobs:
  deploy:
    runs-on: server-1
    steps:
      - name: Setup Environment
        run: |
          DEPLOY_WORKSPACE="/home/ubuntu/demo-production"
          cd $DEPLOY_WORKSPACE

          # Kiểm tra và tạo folder releases nếu chưa tồn tại
          if [ ! -d "releases" ]; then
            mkdir releases
          fi

          # Chuyển đến folder releases
          cd releases

          # Lấy folder version hiện tại (folder có số lớn nhất, nếu có)
          CURRENT_VERSION=$(ls -d [0-9]* 2>/dev/null | sort -n | tail -n 1)
          if [ -z "$CURRENT_VERSION" ]; then
            NEW_VERSION=1
          else
            NEW_VERSION=$((CURRENT_VERSION + 1))
          fi

          # Tính toán version mới
          NEW_VERSION=$((CURRENT_VERSION + 1))

          # Tạo folder mới với tên version mới
          mkdir $NEW_VERSION

          echo "DEPLOY_WORKSPACE=$DEPLOY_WORKSPACE" >> $GITHUB_ENV
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      - name: Clone Code
        run: |
          cd $DEPLOY_WORKSPACE/releases/$NEW_VERSION
          git clone --branch production git@github.com:haiquang9994/workflows-demo.git .

      - name: Setup Application
        run: |
          cd $DEPLOY_WORKSPACE/releases/$NEW_VERSION
          composer install
          cd node
          yarn
          cd ..

          # Copy shared
          ln -s $DEPLOY_WORKSPACE/shared/env .env
          ln -s $DEPLOY_WORKSPACE/shared/console.hosts .console.hosts

          # Quay lại thư mục cha để tạo hoặc cập nhật link symbolic 'current'
          cd $DEPLOY_WORKSPACE
          ln -sfn releases/$NEW_VERSION current

          # Quay lại folder releases để xóa các phiên bản cũ
          cd releases

          # Xóa bớt các phiên bản cũ, giữ lại tối đa 5 phiên bản
          ls -d [0-9]* 2>/dev/null | sort -n | head -n -5 | xargs -r rm -r
